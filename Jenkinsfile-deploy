pipeline{
    agent any

    parameters{
        string(
            name: 'IMAGE TAG',
            description: 'Docker Image tag built in CI (e.g built number)'
        )
    }
    environment {
        REGISTRY = "abhilashkonda77/enterprise-website"
        IMAGE = "${REGISTRY}:${params.IMAGE_TAG}"
        DOCKER_CREDNTIALS= "docker_creds"

    }
    stages {
        stage('push to registry'){
            steps{
                withCredentials([usernamePassword(
                    credentialsId: env.DOCKER_CREDNTIALS,
                    usernameVariable: 'DOCKER_USER'
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    sh """
                    echo "$DOCKER_PASS | docker login -u "$DOCKER_USER" --password-stdin
                    docker push ${IMAGE}
                    """
                }

            }

        }
        stage('deploy on k8s') {
            steps {
                sh """
                sed -i 's|IMAGE_PLACEHOLDER|${IMAGE}|G' deployment.yaml
                kubectl apply -f deployment.yaml
                """
            }
        }
        stage('smoke test') {
            steps{
                sh '''
                kubectl rollout status deployement/sechay-website
                kubectl get pods
                '''
            }
        }
    }
}